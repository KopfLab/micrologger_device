---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r}
#| include: false
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# 3D printed ÂµLogger parts

```{r}
#| echo: false
# define the path to the OpenSCAD executable
openscad_path <- "openscad"

# convert stl to png
convert_stl_to_png <- function(stl, png, overwrite = FALSE) {
  if (file.exists(png) && !overwrite) {
    return(list("already done"))
  }
  # openscad rendering options
  # --autocenter and --viewall ensure the model fits the frame
  cmd_args <- c(
    "-o",
    png,
    "--imgsize=1024,1024",
    "--colorscheme=Starnight",
    "--autocenter",
    "--viewall",
    sprintf("-D 'stl=\"%s\"'", stl),
    "png_converter.scad"
  )

  # execute the conversion
  out <- system2(openscad_path, args = cmd_args, stdout = TRUE, stderr = TRUE)
  return(out)
}

# generate png files for all stls
results <-
  tibble::tibble(
    stl = list.files("stl", pattern = "\\.stl$"),
    label = stl |>
      stringr::str_replace("^micrologger_(.*)_nozzle(.*)$", "\\1") |>
      stringr::str_replace_all(stringr::fixed("_"), " ") |>
      stringr::str_to_title(),
    type = stl |>
      stringr::str_replace("^micrologger_([^_]+)(.*)$", "\\1") |>
      stringr::str_to_title(),
    png = stl |>
      stringr::str_replace("\\.stl$", ".png"),
    result = purrr::map2(
      file.path("stl", stl),
      file.path("png", png),
      convert_stl_to_png
    )
  )
```

```{r}
#| echo: false
#| results: asis
# generate output
results |>
  dplyr::mutate(type = factor(type) |> forcats::fct_relevel("Device")) |>
  dplyr::arrange(type) |>
  dplyr::summarise(
    .by = "type",
    imgs = sprintf(
      "### %s\n\n[![](png/%s)](stl/%s)",
      label,
      png,
      stl
    ) |>
      paste(collapse = "\n\n"),
    code = sprintf("## %s\n\n%s\n\n", type[1], imgs)
  ) |>
  dplyr::pull(code) |>
  cat(sep = "\n\n")
```
